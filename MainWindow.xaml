<Window x:Class="ExcelMatcher.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        mc:Ignorable="d"
        Title="Excel数据匹配合并工具"
        Height="1000" Width="1600"
        MinHeight="800" MinWidth="1200"
        TextElement.Foreground="{DynamicResource MD3OnSurfaceBrush}"
        TextElement.FontWeight="Regular"
        TextElement.FontSize="14"
        TextOptions.TextFormattingMode="Ideal"
        TextOptions.TextRenderingMode="Auto"
        Background="{DynamicResource MD3BackgroundBrush}"
        FontFamily="{materialDesign:MaterialDesignFont}"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        WindowStyle="None"
        ResizeMode="CanResizeWithGrip"
        AllowsTransparency="True">

    <Window.Resources>
        <!-- Section Header Style -->
        <Style x:Key="SectionHeaderStyle" TargetType="TextBlock" BasedOn="{StaticResource MD3TitleLarge}">
            <Setter Property="Margin" Value="0,0,0,24" />
            <Setter Property="FontWeight" Value="Medium" />
        </Style>

        <!-- Info Card Style -->
        <Style x:Key="InfoCardStyle" TargetType="materialDesign:Card" BasedOn="{StaticResource MD3OutlinedCard}">
            <Setter Property="Margin" Value="0,12,0,0" />
            <Setter Property="Background" Value="{StaticResource MD3PrimaryContainerBrush}" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>

        <!-- File Drop Zone Style -->
        <Style x:Key="FileDropZoneStyle" TargetType="Border">
            <Setter Property="BorderBrush" Value="{StaticResource MD3OutlineVariantBrush}" />
            <Setter Property="BorderThickness" Value="2" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Background" Value="{StaticResource MD3SurfaceBrush}" />
            <Setter Property="Padding" Value="16" />
            <Setter Property="MinHeight" Value="56" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="{StaticResource MD3PrimaryBrush}" />
                    <Setter Property="Background" Value="{StaticResource MD3PrimaryContainerBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Field Mapping Item Style -->
        <Style x:Key="FieldMappingItemStyle" TargetType="Grid">
            <Setter Property="Margin" Value="0,8" />
        </Style>

        <!-- Filter Condition Item Style -->
        <Style x:Key="FilterConditionItemStyle" TargetType="Grid">
            <Setter Property="Margin" Value="0,8" />
        </Style>

        <!-- Animation Resources -->

        <Storyboard x:Key="SlideUpAnimation">
            <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)"
                             From="20" To="0" Duration="0:0:0.3">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut" />
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                             From="0" To="1" Duration="0:0:0.3" />
        </Storyboard>

    </Window.Resources>

    <materialDesign:DialogHost Identifier="RootDialog">
        <materialDesign:DialogHost Identifier="ConfirmDialog">
            <Grid>
                <!-- Custom Window Chrome -->
                <Border Background="{StaticResource MD3SurfaceBrush}"
                        CornerRadius="16"
                        BorderThickness="1"
                        BorderBrush="{StaticResource MD3OutlineVariantBrush}"
                        materialDesign:ElevationAssist.Elevation="Dp4">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <!-- Custom Title Bar -->
                        <materialDesign:ColorZone Grid.Row="0"
                                                  Mode="Custom"
                                                  Background="{StaticResource MD3SurfaceBrush}"
                                                  Foreground="{StaticResource MD3OnSurfaceBrush}"
                                                  CornerRadius="16,16,0,0"
                                                  Padding="24,16"
                                                  MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- App Icon and Title -->
                                <StackPanel Grid.Column="0" Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="TableMergeCells"
                                                             Width="32" Height="32"
                                                             VerticalAlignment="Center"
                                                             Foreground="{StaticResource MD3PrimaryBrush}" />
                                    <TextBlock Text="Excel数据匹配合并工具"
                                               Style="{StaticResource MD3TitleLarge}"
                                               VerticalAlignment="Center"
                                               Margin="16,0,0,0" />
                                    <materialDesign:PackIcon Kind="Beta"
                                                             Width="16" Height="16"
                                                             VerticalAlignment="Top"
                                                             Foreground="{StaticResource MD3SecondaryBrush}"
                                                             Margin="8,0,0,0" />
                                </StackPanel>

                                <!-- Window Controls -->
                                <StackPanel Grid.Column="2" Orientation="Horizontal">
                                    <Button x:Name="MinimizeButton"
                                            Style="{StaticResource MaterialDesignIconForegroundButton}"
                                            ToolTip="最小化"
                                            Click="MinimizeButton_Click">
                                        <materialDesign:PackIcon Kind="WindowMinimize" />
                                    </Button>

                                    <Button x:Name="MaximizeButton"
                                            Style="{StaticResource MaterialDesignIconForegroundButton}"
                                            ToolTip="最大化"
                                            Click="MaximizeButton_Click">
                                        <materialDesign:PackIcon Kind="WindowMaximize" />
                                    </Button>

                                    <Button x:Name="CloseButton"
                                            Style="{StaticResource MaterialDesignIconForegroundButton}"
                                            ToolTip="关闭"
                                            Click="CloseButton_Click">
                                        <materialDesign:PackIcon Kind="WindowClose" />
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </materialDesign:ColorZone>

                        <!-- Main Content -->
                        <ScrollViewer Grid.Row="1"
                                      HorizontalScrollBarVisibility="Disabled"
                                      Style="{StaticResource MD3ScrollViewer}"
                                      Padding="24,16,24,0">
                            <StackPanel MaxWidth="1400">

                                <!-- File Selection Section -->
                                <materialDesign:Card Style="{StaticResource MD3Card}">
                                    <StackPanel>
                                        <StackPanel.RenderTransform>
                                            <TranslateTransform />
                                        </StackPanel.RenderTransform>
                                        <StackPanel.Triggers>
                                            <EventTrigger RoutedEvent="Loaded">
                                                <BeginStoryboard Storyboard="{StaticResource SlideUpAnimation}" />
                                            </EventTrigger>
                                        </StackPanel.Triggers>

                                        <Grid Margin="0,0,0,24">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <materialDesign:PackIcon Grid.Column="0"
                                                                     Kind="FileDocument"
                                                                     Width="28" Height="28"
                                                                     VerticalAlignment="Center"
                                                                     Foreground="{StaticResource MD3PrimaryBrush}"
                                                                     Margin="0,0,16,0" />

                                            <TextBlock Grid.Column="1"
                                                       Text="文件选择"
                                                       Style="{StaticResource SectionHeaderStyle}"
                                                       Margin="0" />
                                        </Grid>

                                        <!-- Primary File -->
                                        <Grid Margin="0,0,0,32">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="120" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <TextBlock Grid.Column="0"
                                                       Text="主表文件"
                                                       Style="{StaticResource MD3LabelLarge}"
                                                       VerticalAlignment="Center" />

                                            <!-- Primary File Drop Zone -->
                                            <Border Grid.Column="1"
                                                    Style="{StaticResource FileDropZoneStyle}"
                                                    AllowDrop="True"
                                                    DragEnter="PrimaryFileDropZone_DragEnter"
                                                    DragOver="PrimaryFileDropZone_DragOver"
                                                    DragLeave="PrimaryFileDropZone_DragLeave"
                                                    Drop="PrimaryFileDropZone_Drop">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>

                                                    <!-- File Icon -->
                                                    <materialDesign:PackIcon Grid.Column="0"
                                                                             Kind="FileExcel"
                                                                             Width="24" Height="24"
                                                                             VerticalAlignment="Center"
                                                                             Foreground="{StaticResource MD3PrimaryBrush}"
                                                                             Margin="0,0,12,0" />

                                                    <!-- File Path Display -->
                                                    <TextBox Grid.Column="1"
                                                             Text="{Binding PrimaryFilePath}"
                                                             Style="{StaticResource MD3TextBox}"
                                                             materialDesign:HintAssist.Hint="拖拽主表Excel文件到此处或点击浏览"
                                                             IsReadOnly="True"
                                                             ToolTip="{Binding PrimaryFilePath}"
                                                             Margin="0,0,12,0" />

                                                    <!-- Password Field -->
                                                    <PasswordBox Grid.Column="2"
                                                                 x:Name="PrimaryPasswordBox"
                                                                 materialDesign:HintAssist.Hint="密码(可选)"
                                                                 Style="{StaticResource MaterialDesignOutlinedPasswordBox}"
                                                                 Width="120"
                                                                 Margin="0,0,12,0"
                                                                 PasswordChanged="PrimaryPasswordBox_PasswordChanged" />

                                                    <!-- Browse Button -->
                                                    <Button Grid.Column="3"
                                                            Command="{Binding BrowsePrimaryFileCommand}"
                                                            Style="{StaticResource MD3FilledButton}"
                                                            Margin="0,0,8,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <materialDesign:PackIcon Kind="FolderOpen"
                                                                Width="18" Height="18"
                                                                Margin="0,0,8,0" />
                                                            <TextBlock Text="浏览" />
                                                        </StackPanel>
                                                    </Button>

                                                    <!-- Clear Button -->
                                                    <Button Grid.Column="4"
                                                            Style="{StaticResource MaterialDesignIconButton}"
                                                            ToolTip="清除文件"
                                                            Command="{Binding ClearPrimaryFileCommand}"
                                                            Visibility="{Binding PrimaryFile.IsLoaded, 
                                                                  Converter={StaticResource BooleanToVisibilityConverter}}">
                                                        <materialDesign:PackIcon Kind="Close"
                                                            Foreground="{StaticResource MD3ErrorBrush}" />
                                                    </Button>
                                                </Grid>
                                            </Border>

                                            <!-- File Info Card -->
                                            <materialDesign:Card Grid.Row="1" Grid.Column="1"
                                                                 Style="{StaticResource InfoCardStyle}"
                                                                 Visibility="{Binding PrimaryFile.IsLoaded, 
                                                                       Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <StackPanel Orientation="Horizontal">
                                                    <materialDesign:PackIcon Kind="CheckCircle"
                                                                             Foreground="{StaticResource MD3OnPrimaryContainerBrush}"
                                                                             Width="20" Height="20"
                                                                             Margin="0,0,12,0" />
                                                    <TextBlock Foreground="{StaticResource MD3OnPrimaryContainerBrush}"
                                                               Style="{StaticResource MD3BodyMedium}">
                                                        <Run Text="已成功加载" />
                                                        <Run Text="{Binding PrimaryFile.WorksheetCount, Mode=OneWay}"
                                                             FontWeight="Medium" />
                                                        <Run Text="个工作表" />
                                                    </TextBlock>
                                                </StackPanel>
                                            </materialDesign:Card>
                                        </Grid>

                                        <!-- Secondary File -->
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="120" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <TextBlock Grid.Column="0"
                                                       Text="辅助表文件"
                                                       Style="{StaticResource MD3LabelLarge}"
                                                       VerticalAlignment="Center" />

                                            <!-- Secondary File Drop Zone -->
                                            <Border Grid.Column="1"
                                                    Style="{StaticResource FileDropZoneStyle}"
                                                    AllowDrop="True"
                                                    DragEnter="SecondaryFileDropZone_DragEnter"
                                                    DragOver="SecondaryFileDropZone_DragOver"
                                                    DragLeave="SecondaryFileDropZone_DragLeave"
                                                    Drop="SecondaryFileDropZone_Drop">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>

                                                    <!-- File Icon -->
                                                    <materialDesign:PackIcon Grid.Column="0"
                                                                             Kind="FileExcel"
                                                                             Width="24" Height="24"
                                                                             VerticalAlignment="Center"
                                                                             Foreground="{StaticResource MD3SecondaryBrush}"
                                                                             Margin="0,0,12,0" />

                                                    <!-- File Path Display -->
                                                    <TextBox Grid.Column="1"
                                                             Text="{Binding SecondaryFilePath}"
                                                             Style="{StaticResource MD3TextBox}"
                                                             materialDesign:HintAssist.Hint="拖拽辅助表Excel文件到此处或点击浏览"
                                                             IsReadOnly="True"
                                                             ToolTip="{Binding SecondaryFilePath}"
                                                             Margin="0,0,12,0" />

                                                    <!-- Password Field -->
                                                    <PasswordBox Grid.Column="2"
                                                                 x:Name="SecondaryPasswordBox"
                                                                 materialDesign:HintAssist.Hint="密码(可选)"
                                                                 Style="{StaticResource MaterialDesignOutlinedPasswordBox}"
                                                                 Width="120"
                                                                 Margin="0,0,12,0"
                                                                 PasswordChanged="SecondaryPasswordBox_PasswordChanged" />

                                                    <!-- Browse Button -->
                                                    <Button Grid.Column="3"
                                                            Command="{Binding BrowseSecondaryFileCommand}"
                                                            Style="{StaticResource MD3FilledButton}"
                                                            Margin="0,0,8,0">
                                                        <StackPanel Orientation="Horizontal">
                                                            <materialDesign:PackIcon Kind="FolderOpen"
                                                                Width="18" Height="18"
                                                                Margin="0,0,8,0" />
                                                            <TextBlock Text="浏览" />
                                                        </StackPanel>
                                                    </Button>

                                                    <!-- Clear Button -->
                                                    <Button Grid.Column="4"
                                                            Style="{StaticResource MaterialDesignIconButton}"
                                                            Command="{Binding ClearSecondaryFileCommand}"
                                                            ToolTip="清除文件"
                                                            Visibility="{Binding SecondaryFile.IsLoaded, 
                                                                  Converter={StaticResource BooleanToVisibilityConverter}}">
                                                        <materialDesign:PackIcon Kind="Close"
                                                            Foreground="{StaticResource MD3ErrorBrush}" />
                                                    </Button>
                                                </Grid>
                                            </Border>

                                            <!-- File Info Card -->
                                            <materialDesign:Card Grid.Row="1" Grid.Column="1"
                                                                 Style="{StaticResource InfoCardStyle}"
                                                                 Visibility="{Binding SecondaryFile.IsLoaded, 
                                                                       Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <StackPanel Orientation="Horizontal">
                                                    <materialDesign:PackIcon Kind="CheckCircle"
                                                                             Foreground="{StaticResource MD3OnPrimaryContainerBrush}"
                                                                             Width="20" Height="20"
                                                                             Margin="0,0,12,0" />
                                                    <TextBlock Foreground="{StaticResource MD3OnPrimaryContainerBrush}"
                                                               Style="{StaticResource MD3BodyMedium}">
                                                        <Run Text="已成功加载" />
                                                        <Run Text="{Binding SecondaryFile.WorksheetCount, Mode=OneWay}"
                                                             FontWeight="Medium" />
                                                        <Run Text="个工作表" />
                                                    </TextBlock>
                                                </StackPanel>
                                            </materialDesign:Card>
                                        </Grid>
                                        
                                        

                                        <!-- Quick Actions -->
                                        <StackPanel Orientation="Horizontal"
                                                    HorizontalAlignment="Right"
                                                    Margin="0,32,0,0">

                                            <!-- 数据预览开关区域 -->
                                            <materialDesign:Card Style="{StaticResource MD3OutlinedCard}"
                                                                 Padding="16,12"
                                                                 Margin="0,0,16,0">
                                                <StackPanel Orientation="Horizontal">
                                                    <!-- 开关图标和文本 -->
                                                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center"
                                                                Margin="0,0,16,0">
                                                        <materialDesign:PackIcon Kind="Eye"
                                                            Width="18" Height="18"
                                                            Margin="0,0,8,0"
                                                            Foreground="{StaticResource MD3PrimaryBrush}" />
                                                        <TextBlock Text="数据预览开关"
                                                                   Style="{StaticResource MD3LabelLarge}"
                                                                   VerticalAlignment="Center" />
                                                    </StackPanel>

                                                    <!-- 开关控件 -->
                                                    <ToggleButton x:Name="PreviewToggleButton"
                                                                  IsChecked="{Binding IsPreviewEnabled}"
                                                                  Style="{StaticResource MaterialDesignSwitchToggleButton}"
                                                                  ToolTip="启用数据预览可查看文件内容，但会影响大文件处理性能。关闭预览可显著提高加载速度。" />
                                                </StackPanel>
                                            </materialDesign:Card>
                                            
                                            <Button Command="{Binding RefreshDataCommand}"
                                                    Style="{StaticResource MD3OutlinedButton}"
                                                    ToolTip="重新加载文件数据">
                                                <StackPanel Orientation="Horizontal">
                                                    <materialDesign:PackIcon Kind="Refresh"
                                                                             Width="18" Height="18"
                                                                             Margin="0,0,8,0" />
                                                    <TextBlock Text="刷新数据" />
                                                </StackPanel>
                                            </Button>
                                        </StackPanel>
                                    </StackPanel>
                                </materialDesign:Card>

                                <!-- Worksheet Selection Section -->
                                <materialDesign:Card Style="{StaticResource MD3Card}">
                                    <StackPanel>
                                        <Grid Margin="0,0,0,24">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <materialDesign:PackIcon Grid.Column="0"
                                                                     Kind="TableMultiple"
                                                                     Width="28" Height="28"
                                                                     VerticalAlignment="Center"
                                                                     Foreground="{StaticResource MD3PrimaryBrush}"
                                                                     Margin="0,0,16,0" />

                                            <TextBlock Grid.Column="1"
                                                       Text="工作表选择"
                                                       Style="{StaticResource SectionHeaderStyle}"
                                                       Margin="0" />
                                        </Grid>

                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="48" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <!-- Primary Worksheets -->
                                            <materialDesign:Card Grid.Column="0"
                                                                 Style="{StaticResource MD3OutlinedCard}">
                                                <StackPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                                        <materialDesign:PackIcon Kind="Table"
                                                            Foreground="{StaticResource MD3PrimaryBrush}"
                                                            Width="20" Height="20"
                                                            Margin="0,0,8,0" />
                                                        <TextBlock Text="主表工作表" Style="{StaticResource MD3TitleMedium}" />
                                                    </StackPanel>

                                                    <ListBox x:Name="PrimaryWorksheetsListBox"
                                                             ItemsSource="{Binding PrimaryWorksheets}"
                                                             SelectionMode="Extended"
                                                             Style="{StaticResource MD3ListBox}"
                                                             MaxHeight="200"
                                                             MinHeight="120">
                                                        <i:Interaction.Triggers>
                                                            <i:EventTrigger EventName="SelectionChanged">
                                                                <i:InvokeCommandAction
                                                                    Command="{Binding UpdateSelectedPrimaryWorksheetsCommand}"
                                                                    CommandParameter="{Binding ElementName=PrimaryWorksheetsListBox, Path=SelectedItems}" />
                                                            </i:EventTrigger>
                                                        </i:Interaction.Triggers>
                                                    </ListBox>

                                                    <!-- Selection Info -->
                                                    <materialDesign:Card Style="{StaticResource MD3OutlinedCard}"
                                                                         Margin="0,16,0,0"
                                                                         Background="{StaticResource MD3SecondaryContainerBrush}">
                                                        <StackPanel>
                                                            <TextBlock Style="{StaticResource MD3LabelMedium}"
                                                                       Foreground="{StaticResource MD3OnSecondaryContainerBrush}">
                                                                <materialDesign:PackIcon Kind="CheckboxMarked"
                                                                    Width="16" Height="16"
                                                                    VerticalAlignment="Center"
                                                                    Margin="0,0,4,0" />
                                                                <Run Text="已选择" />
                                                                <Run
                                                                    Text="{Binding SelectedPrimaryWorksheets.Count, Mode=OneWay}"
                                                                    FontWeight="Bold" />
                                                                <Run Text="个工作表" />
                                                            </TextBlock>
                                                        </StackPanel>
                                                    </materialDesign:Card>
                                                </StackPanel>
                                            </materialDesign:Card>

                                            <!-- Connection Arrow -->
                                            <Grid Grid.Column="1">
                                                <materialDesign:PackIcon Kind="ArrowLeftRight"
                                                                         HorizontalAlignment="Center"
                                                                         VerticalAlignment="Center"
                                                                         Width="32" Height="32"
                                                                         Foreground="{StaticResource MD3PrimaryBrush}" />
                                            </Grid>

                                            <!-- Secondary Worksheets -->
                                            <materialDesign:Card Grid.Column="2"
                                                                 Style="{StaticResource MD3OutlinedCard}">
                                                <StackPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                                        <materialDesign:PackIcon Kind="Table"
                                                            Foreground="{StaticResource MD3SecondaryBrush}"
                                                            Width="20" Height="20"
                                                            Margin="0,0,8,0" />
                                                        <TextBlock Text="辅助表工作表"
                                                                   Style="{StaticResource MD3TitleMedium}" />
                                                    </StackPanel>

                                                    <ListBox x:Name="SecondaryWorksheetsListBox"
                                                             ItemsSource="{Binding SecondaryWorksheets}"
                                                             SelectionMode="Extended"
                                                             Style="{StaticResource MD3ListBox}"
                                                             MaxHeight="200"
                                                             MinHeight="120">
                                                        <i:Interaction.Triggers>
                                                            <i:EventTrigger EventName="SelectionChanged">
                                                                <i:InvokeCommandAction
                                                                    Command="{Binding UpdateSelectedSecondaryWorksheetsCommand}"
                                                                    CommandParameter="{Binding ElementName=SecondaryWorksheetsListBox, Path=SelectedItems}" />
                                                            </i:EventTrigger>
                                                        </i:Interaction.Triggers>
                                                    </ListBox>

                                                    <!-- Selection Info -->
                                                    <materialDesign:Card Style="{StaticResource MD3OutlinedCard}"
                                                                         Margin="0,16,0,0"
                                                                         Background="{StaticResource MD3SecondaryContainerBrush}">
                                                        <StackPanel>
                                                            <TextBlock Style="{StaticResource MD3LabelMedium}"
                                                                       Foreground="{StaticResource MD3OnSecondaryContainerBrush}">
                                                                <materialDesign:PackIcon Kind="CheckboxMarked"
                                                                    Width="16" Height="16"
                                                                    VerticalAlignment="Center"
                                                                    Margin="0,0,4,0" />
                                                                <Run Text="已选择" />
                                                                <Run
                                                                    Text="{Binding SelectedSecondaryWorksheets.Count, Mode=OneWay}"
                                                                    FontWeight="Bold" />
                                                                <Run Text="个工作表" />
                                                            </TextBlock>
                                                        </StackPanel>
                                                    </materialDesign:Card>
                                                </StackPanel>
                                            </materialDesign:Card>
                                        </Grid>
                                    </StackPanel>
                                </materialDesign:Card>

                                <!-- Field Configuration Section -->
                                <materialDesign:Card Style="{StaticResource MD3Card}">
                                    <StackPanel>
                                        <Grid Margin="0,0,0,24">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <materialDesign:PackIcon Grid.Column="0"
                                                                     Kind="LinkVariant"
                                                                     Width="28" Height="28"
                                                                     VerticalAlignment="Center"
                                                                     Foreground="{StaticResource MD3PrimaryBrush}"
                                                                     Margin="0,0,16,0" />

                                            <TextBlock Grid.Column="1"
                                                       Text="字段配置"
                                                       Style="{StaticResource SectionHeaderStyle}"
                                                       Margin="0" />
                                        </Grid>

                                        <!-- Matching Fields -->
                                        <materialDesign:Card Style="{StaticResource MD3OutlinedCard}" Margin="0,0,0,24">
                                            <StackPanel>
                                                <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                                    <materialDesign:PackIcon Kind="LinkBox"
                                                                             Foreground="{StaticResource MD3PrimaryBrush}"
                                                                             Width="24" Height="24"
                                                                             Margin="0,0,12,0" />
                                                    <TextBlock Text="匹配字段选择" Style="{StaticResource MD3TitleMedium}" />
                                                    <materialDesign:PackIcon Kind="InformationOutline"
                                                                             Width="20" Height="20"
                                                                             Margin="16,0,8,0"
                                                                             Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                                             ToolTip="选择用于匹配主表和辅助表数据的字段" />
                                                </StackPanel>

                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Primary Match Fields -->
                                                    <StackPanel Grid.Column="0">
                                                        <TextBlock Text="主表匹配字段"
                                                                   Style="{StaticResource MD3LabelLarge}"
                                                                   Margin="0,0,0,8" />
                                                        <materialDesign:Card Style="{StaticResource MD3OutlinedCard}">
                                                            <ListBox x:Name="PrimaryMatchFieldsListBox"
                                                                     ItemsSource="{Binding PrimaryColumns}"
                                                                     SelectionMode="Extended"
                                                                     Style="{StaticResource MD3ListBox}"
                                                                     Height="180">
                                                                <i:Interaction.Triggers>
                                                                    <i:EventTrigger EventName="SelectionChanged">
                                                                        <i:InvokeCommandAction
                                                                            Command="{Binding UpdateSelectedPrimaryMatchFieldsCommand}"
                                                                            CommandParameter="{Binding ElementName=PrimaryMatchFieldsListBox, Path=SelectedItems}" />
                                                                    </i:EventTrigger>
                                                                </i:Interaction.Triggers>
                                                            </ListBox>
                                                        </materialDesign:Card>
                                                    </StackPanel>

                                                    <!-- Match Indicator -->
                                                    <StackPanel Grid.Column="1"
                                                                VerticalAlignment="Center"
                                                                Margin="24,0">
                                                        <materialDesign:PackIcon Kind="ArrowLeftRight"
                                                            Width="40" Height="40"
                                                            Foreground="{StaticResource MD3PrimaryBrush}" />
                                                        <TextBlock Text="匹配关联"
                                                                   Style="{StaticResource MD3LabelMedium}"
                                                                   HorizontalAlignment="Center"
                                                                   Margin="0,8,0,0" />
                                                    </StackPanel>

                                                    <!-- Secondary Match Fields -->
                                                    <StackPanel Grid.Column="2">
                                                        <TextBlock Text="辅助表匹配字段"
                                                                   Style="{StaticResource MD3LabelLarge}"
                                                                   Margin="0,0,0,8" />
                                                        <materialDesign:Card Style="{StaticResource MD3OutlinedCard}">
                                                            <ListBox x:Name="SecondaryMatchFieldsListBox"
                                                                     ItemsSource="{Binding SecondaryColumns}"
                                                                     SelectionMode="Extended"
                                                                     Style="{StaticResource MD3ListBox}"
                                                                     Height="180">
                                                                <i:Interaction.Triggers>
                                                                    <i:EventTrigger EventName="SelectionChanged">
                                                                        <i:InvokeCommandAction
                                                                            Command="{Binding UpdateSelectedSecondaryMatchFieldsCommand}"
                                                                            CommandParameter="{Binding ElementName=SecondaryMatchFieldsListBox, Path=SelectedItems}" />
                                                                    </i:EventTrigger>
                                                                </i:Interaction.Triggers>
                                                            </ListBox>
                                                        </materialDesign:Card>
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </materialDesign:Card>

                                        <!-- Field Mappings -->
                                        <materialDesign:Card Style="{StaticResource MD3OutlinedCard}">
                                            <StackPanel>
                                                <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                                    <materialDesign:PackIcon Kind="MapMarker"
                                                                             Foreground="{StaticResource MD3SecondaryBrush}"
                                                                             Width="24" Height="24"
                                                                             Margin="0,0,12,0" />
                                                    <TextBlock Text="字段映射" Style="{StaticResource MD3TitleMedium}" />
                                                    <TextBlock Text="（辅助表字段 → 主表字段）"
                                                               Style="{StaticResource MD3LabelMedium}"
                                                               Margin="8,0,0,0" />
                                                    <materialDesign:PackIcon Kind="InformationOutline"
                                                                             Width="20" Height="20"
                                                                             Margin="16,0,8,0"
                                                                             Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                                             ToolTip="配置将辅助表数据复制到主表的字段映射关系" />
                                                </StackPanel>

                                                <!-- Mapping Header -->
                                                <Grid Margin="0,0,0,8">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>

                                                    <TextBlock Grid.Column="0"
                                                               Text="源字段 (辅助表)"
                                                               Style="{StaticResource MD3LabelLarge}"
                                                               Margin="8,0,0,0" />
                                                    <TextBlock Grid.Column="2"
                                                               Text="目标字段 (主表)"
                                                               Style="{StaticResource MD3LabelLarge}"
                                                               Margin="8,0,0,0" />
                                                    <TextBlock Grid.Column="3"
                                                               Text="操作"
                                                               Style="{StaticResource MD3LabelLarge}"
                                                               HorizontalAlignment="Center" />
                                                </Grid>

                                                <!-- Mapping List -->
                                                <ScrollViewer MaxHeight="300"
                                                              Style="{StaticResource MD3ScrollViewer}">
                                                    <ItemsControl ItemsSource="{Binding FieldMappings}">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <materialDesign:Card
                                                                    Style="{StaticResource MD3OutlinedCard}"
                                                                    Margin="0,4">
                                                                    <Grid
                                                                        Style="{StaticResource FieldMappingItemStyle}">
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="*" />
                                                                            <ColumnDefinition Width="Auto" />
                                                                            <ColumnDefinition Width="*" />
                                                                            <ColumnDefinition Width="Auto" />
                                                                        </Grid.ColumnDefinitions>

                                                                        <!-- Source Field -->
                                                                        <ComboBox Grid.Column="0"
                                                                            ItemsSource="{Binding DataContext.SecondaryColumns, 
                                                                                    RelativeSource={RelativeSource AncestorType=Window}}"
                                                                            SelectedItem="{Binding SourceField, UpdateSourceTrigger=PropertyChanged}"
                                                                            Style="{StaticResource MD3ComboBox}"
                                                                            materialDesign:HintAssist.Hint="选择源字段"
                                                                            ToolTip="选择辅助表中的源字段" />

                                                                        <!-- Arrow -->
                                                                        <materialDesign:PackIcon Grid.Column="1"
                                                                            Kind="ArrowRight"
                                                                            VerticalAlignment="Center"
                                                                            Margin="16,0"
                                                                            Foreground="{StaticResource MD3PrimaryBrush}" />

                                                                        <!-- Target Field -->
                                                                        <ComboBox Grid.Column="2"
                                                                            ItemsSource="{Binding DataContext.PrimaryColumns, 
                                                                                    RelativeSource={RelativeSource AncestorType=Window}}"
                                                                            SelectedItem="{Binding TargetField, UpdateSourceTrigger=PropertyChanged}"
                                                                            Text="{Binding TargetField, UpdateSourceTrigger=PropertyChanged}"
                                                                            Style="{StaticResource MD3EditableComboBox}"
                                                                            materialDesign:HintAssist.Hint="选择或输入目标字段"
                                                                            ToolTip="选择主表中的目标字段或输入新字段名" />

                                                                        <!-- Remove Button -->
                                                                        <Button Grid.Column="3"
                                                                            Command="{Binding DataContext.RemoveFieldMappingCommand, 
                                                                                  RelativeSource={RelativeSource AncestorType=Window}}"
                                                                            CommandParameter="{Binding}"
                                                                            Style="{StaticResource MaterialDesignIconButton}"
                                                                            Margin="16,0,0,0"
                                                                            ToolTip="删除此字段映射">
                                                                            <materialDesign:PackIcon
                                                                                Kind="DeleteOutline"
                                                                                Foreground="{StaticResource MD3ErrorBrush}" />
                                                                        </Button>
                                                                    </Grid>
                                                                </materialDesign:Card>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </ScrollViewer>

                                                <!-- Add Mapping Button -->
                                                <Button Command="{Binding AddFieldMappingCommand}"
                                                        Style="{StaticResource MD3OutlinedButton}"
                                                        HorizontalAlignment="Left"
                                                        Margin="0,16,0,0">
                                                    <StackPanel Orientation="Horizontal">
                                                        <materialDesign:PackIcon Kind="Plus"
                                                            Width="18" Height="18"
                                                            Margin="0,0,8,0" />
                                                        <TextBlock Text="添加字段映射" />
                                                    </StackPanel>
                                                </Button>
                                            </StackPanel>
                                        </materialDesign:Card>
                                    </StackPanel>
                                </materialDesign:Card>

                                <!-- Data Filtering Section -->
                                <materialDesign:Card Style="{StaticResource MD3Card}">
                                    <StackPanel>
                                        <Grid Margin="0,0,0,24">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <materialDesign:PackIcon Grid.Column="0"
                                                                     Kind="FilterVariant"
                                                                     Width="28" Height="28"
                                                                     VerticalAlignment="Center"
                                                                     Foreground="{StaticResource MD3PrimaryBrush}"
                                                                     Margin="0,0,16,0" />

                                            <TextBlock Grid.Column="1"
                                                       Text="数据筛选"
                                                       Style="{StaticResource SectionHeaderStyle}"
                                                       Margin="0" />
                                        </Grid>

                                        <!-- Primary Filters -->
                                        <Expander Header="主表筛选条件"
                                                  IsExpanded="False"
                                                  Style="{StaticResource MD3ExpanderSimple}"
                                                  Margin="0,0,0,16">
                                            <StackPanel Margin="0,16,0,0">
                                                <!-- Filter List -->
                                                <ItemsControl ItemsSource="{Binding PrimaryFilters}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <materialDesign:Card
                                                                Style="{StaticResource MD3OutlinedCard}"
                                                                Margin="0,4">
                                                                <Grid Style="{StaticResource FilterConditionItemStyle}">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="Auto" />
                                                                        <ColumnDefinition Width="*" />
                                                                        <ColumnDefinition Width="Auto" />
                                                                        <ColumnDefinition Width="*" />
                                                                        <ColumnDefinition Width="Auto" />
                                                                    </Grid.ColumnDefinitions>

                                                                    <!-- Logical Operator -->
                                                                    <ComboBox Grid.Column="0"
                                                                              ItemsSource="{Binding DataContext.LogicalOperators, 
                                                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                                                              SelectedItem="{Binding LogicalOperator, UpdateSourceTrigger=PropertyChanged}"
                                                                              Style="{StaticResource MD3ComboBox}"
                                                                              materialDesign:HintAssist.Hint="逻辑"
                                                                              Width="100"
                                                                              Visibility="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ContentPresenter}}, 
                                                                                Converter={StaticResource IndexToVisibilityConverter}}">
                                                                        <ComboBox.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <TextBlock
                                                                                    Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"
                                                                                    Style="{StaticResource MD3BodyMedium}" />
                                                                            </DataTemplate>
                                                                        </ComboBox.ItemTemplate>
                                                                    </ComboBox>

                                                                    <!-- Field -->
                                                                    <ComboBox Grid.Column="1"
                                                                              ItemsSource="{Binding DataContext.PrimaryColumns, 
                                                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                                                              SelectedItem="{Binding Field, UpdateSourceTrigger=PropertyChanged}"
                                                                              Style="{StaticResource MD3ComboBox}"
                                                                              materialDesign:HintAssist.Hint="选择字段"
                                                                              Margin="8,0" />

                                                                    <!-- Operator -->
                                                                    <ComboBox Grid.Column="2"
                                                                              ItemsSource="{Binding DataContext.FilterOperators, 
                                                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                                                              SelectedItem="{Binding Operator, UpdateSourceTrigger=PropertyChanged}"
                                                                              Style="{StaticResource MD3ComboBox}"
                                                                              materialDesign:HintAssist.Hint="运算符"
                                                                              Width="140"
                                                                              Margin="0,0,8,0">
                                                                        <ComboBox.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <TextBlock
                                                                                    Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"
                                                                                    Style="{StaticResource MD3BodyMedium}" />
                                                                            </DataTemplate>
                                                                        </ComboBox.ItemTemplate>
                                                                    </ComboBox>

                                                                    <!-- Value -->
                                                                    <TextBox Grid.Column="3"
                                                                             Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                                                             Style="{StaticResource MD3TextBox}"
                                                                             materialDesign:HintAssist.Hint="筛选值"
                                                                             Margin="0,0,8,0" />

                                                                    <!-- Remove Button -->
                                                                    <Button Grid.Column="4"
                                                                            Command="{Binding DataContext.RemovePrimaryFilterCommand, 
                                                                              RelativeSource={RelativeSource AncestorType=Window}}"
                                                                            CommandParameter="{Binding}"
                                                                            Style="{StaticResource MaterialDesignIconButton}">
                                                                        <materialDesign:PackIcon Kind="DeleteOutline"
                                                                            Foreground="{StaticResource MD3ErrorBrush}" />
                                                                    </Button>
                                                                </Grid>
                                                            </materialDesign:Card>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>

                                                <!-- Add Filter Button -->
                                                <Button Command="{Binding AddPrimaryFilterCommand}"
                                                        Style="{StaticResource MD3OutlinedButton}"
                                                        HorizontalAlignment="Left"
                                                        Margin="0,16,0,0">
                                                    <StackPanel Orientation="Horizontal">
                                                        <materialDesign:PackIcon Kind="Plus"
                                                            Width="18" Height="18"
                                                            Margin="0,0,8,0" />
                                                        <TextBlock Text="添加筛选条件" />
                                                    </StackPanel>
                                                </Button>
                                            </StackPanel>
                                        </Expander>

                                        <!-- Secondary Filters -->
                                        <Expander Header="辅助表筛选条件"
                                                  IsExpanded="False"
                                                  Style="{StaticResource MD3ExpanderSimple}">
                                            <StackPanel Margin="0,16,0,0">
                                                <!-- Filter List -->
                                                <ItemsControl ItemsSource="{Binding SecondaryFilters}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <materialDesign:Card
                                                                Style="{StaticResource MD3OutlinedCard}"
                                                                Margin="0,4">
                                                                <Grid Style="{StaticResource FilterConditionItemStyle}">
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="Auto" />
                                                                        <ColumnDefinition Width="*" />
                                                                        <ColumnDefinition Width="Auto" />
                                                                        <ColumnDefinition Width="*" />
                                                                        <ColumnDefinition Width="Auto" />
                                                                    </Grid.ColumnDefinitions>

                                                                    <!-- Logical Operator -->
                                                                    <ComboBox Grid.Column="0"
                                                                              ItemsSource="{Binding DataContext.LogicalOperators, 
                                                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                                                              SelectedItem="{Binding LogicalOperator, UpdateSourceTrigger=PropertyChanged}"
                                                                              Style="{StaticResource MD3ComboBox}"
                                                                              materialDesign:HintAssist.Hint="逻辑"
                                                                              Width="100"
                                                                              Visibility="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ContentPresenter}}, 
                                                                                Converter={StaticResource IndexToVisibilityConverter}}">
                                                                        <ComboBox.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <TextBlock
                                                                                    Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"
                                                                                    Style="{StaticResource MD3BodyMedium}" />
                                                                            </DataTemplate>
                                                                        </ComboBox.ItemTemplate>
                                                                    </ComboBox>

                                                                    <!-- Field -->
                                                                    <ComboBox Grid.Column="1"
                                                                              ItemsSource="{Binding DataContext.SecondaryColumns, 
                                                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                                                              SelectedItem="{Binding Field, UpdateSourceTrigger=PropertyChanged}"
                                                                              Style="{StaticResource MD3ComboBox}"
                                                                              materialDesign:HintAssist.Hint="选择字段"
                                                                              Margin="8,0" />

                                                                    <!-- Operator -->
                                                                    <ComboBox Grid.Column="2"
                                                                              ItemsSource="{Binding DataContext.FilterOperators, 
                                                                                RelativeSource={RelativeSource AncestorType=Window}}"
                                                                              SelectedItem="{Binding Operator, UpdateSourceTrigger=PropertyChanged}"
                                                                              Style="{StaticResource MD3ComboBox}"
                                                                              materialDesign:HintAssist.Hint="运算符"
                                                                              Width="140"
                                                                              Margin="0,0,8,0">
                                                                        <ComboBox.ItemTemplate>
                                                                            <DataTemplate>
                                                                                <TextBlock
                                                                                    Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"
                                                                                    Style="{StaticResource MD3BodyMedium}" />
                                                                            </DataTemplate>
                                                                        </ComboBox.ItemTemplate>
                                                                    </ComboBox>

                                                                    <!-- Value -->
                                                                    <TextBox Grid.Column="3"
                                                                             Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                                                             Style="{StaticResource MD3TextBox}"
                                                                             materialDesign:HintAssist.Hint="筛选值"
                                                                             Margin="0,0,8,0" />

                                                                    <!-- Remove Button -->
                                                                    <Button Grid.Column="4"
                                                                            Command="{Binding DataContext.RemoveSecondaryFilterCommand, 
                                                                              RelativeSource={RelativeSource AncestorType=Window}}"
                                                                            CommandParameter="{Binding}"
                                                                            Style="{StaticResource MaterialDesignIconButton}">
                                                                        <materialDesign:PackIcon Kind="DeleteOutline"
                                                                            Foreground="{StaticResource MD3ErrorBrush}" />
                                                                    </Button>
                                                                </Grid>
                                                            </materialDesign:Card>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>

                                                <!-- Add Filter Button -->
                                                <Button Command="{Binding AddSecondaryFilterCommand}"
                                                        Style="{StaticResource MD3OutlinedButton}"
                                                        HorizontalAlignment="Left"
                                                        Margin="0,16,0,0">
                                                    <StackPanel Orientation="Horizontal">
                                                        <materialDesign:PackIcon Kind="Plus"
                                                            Width="18" Height="18"
                                                            Margin="0,0,8,0" />
                                                        <TextBlock Text="添加筛选条件" />
                                                    </StackPanel>
                                                </Button>
                                            </StackPanel>
                                        </Expander>
                                    </StackPanel>
                                </materialDesign:Card>

                                <!-- Data Preview Section -->
                                <materialDesign:Card Style="{StaticResource MD3Card}">
                                    <StackPanel>
                                        <Grid Margin="0,0,0,24">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <materialDesign:PackIcon Grid.Column="0"
                                                                     Kind="Eye"
                                                                     Width="28" Height="28"
                                                                     VerticalAlignment="Center"
                                                                     Foreground="{StaticResource MD3PrimaryBrush}"
                                                                     Margin="0,0,16,0" />

                                            <TextBlock Grid.Column="1"
                                                       Text="数据预览"
                                                       Style="{StaticResource SectionHeaderStyle}"
                                                       Margin="0" />
                                        </Grid>

                                        <Grid Margin="0,16,0,0">
                                            <!-- 预览已禁用的提示 -->
                                            <StackPanel VerticalAlignment="Center"
                                                        HorizontalAlignment="Center"
                                                        Visibility="{Binding IsPreviewEnabled, 
                      Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                                <materialDesign:PackIcon Kind="EyeOff"
                                                                         Width="64" Height="64"
                                                                         Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                                         Margin="0,0,0,16" />
                                                <TextBlock Text="数据预览已关闭"
                                                           Style="{StaticResource MD3HeadlineSmall}"
                                                           Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                           HorizontalAlignment="Center"
                                                           FontWeight="Medium" />
                                                <TextBlock Text="当前运行在性能优化模式下"
                                                           Style="{StaticResource MD3BodyLarge}"
                                                           Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                           HorizontalAlignment="Center"
                                                           Margin="0,8,0,0" />
                                                <TextBlock Text="启用数据预览开关可查看文件内容，但会影响大文件处理性能"
                                                           Style="{StaticResource MD3BodyMedium}"
                                                           Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                           HorizontalAlignment="Center"
                                                           TextWrapping="Wrap"
                                                           MaxWidth="400"
                                                           TextAlignment="Center"
                                                           Margin="0,16,0,24" />

                                                <!-- 启用预览按钮 -->
                                                <Button Style="{StaticResource MD3FilledButton}"
                                                        Click="EnablePreview_Click">
                                                    <StackPanel Orientation="Horizontal">
                                                        <materialDesign:PackIcon Kind="Eye"
                                                            Width="18" Height="18"
                                                            Margin="0,0,8,0" />
                                                        <TextBlock Text="启用数据预览" />
                                                    </StackPanel>
                                                </Button>
                                            </StackPanel>

                                            <!-- 现有的数据显示内容 -->
                                            <ScrollViewer
                                                Visibility="{Binding IsPreviewEnabled, 
                              Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <TabControl Style="{StaticResource MD3TabControl}">
                                                    <!-- Primary Data Tab -->
                                                    <TabItem Style="{StaticResource MD3TabItem}">
                                                        <TabItem.Header>
                                                            <StackPanel Orientation="Horizontal">
                                                                <materialDesign:PackIcon Kind="Table"
                                                                    Width="20" Height="20"
                                                                    Margin="0,0,8,0" />
                                                                <TextBlock Text="主表数据" />
                                                                <materialDesign:Chip
                                                                    Content="{Binding SelectedPrimaryWorksheets.Count, StringFormat='{}{0}个工作表'}"
                                                                    Margin="8,0,0,0"
                                                                    Style="{StaticResource MaterialDesignOutlineChip}"
                                                                    FontSize="10"
                                                                    Visibility="{Binding SelectedPrimaryWorksheets.Count, 
                                           Converter={StaticResource CountToVisibilityConverter}}" />
                                                            </StackPanel>
                                                        </TabItem.Header>
                                                        <Grid Margin="0,16,0,0">
                                                            <!-- Empty State -->
                                                            <StackPanel VerticalAlignment="Center"
                                                                        HorizontalAlignment="Center"
                                                                        Visibility="{Binding HasPrimaryPreviewData, 
                              Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                                                <materialDesign:PackIcon Kind="TableOff"
                                                                    Width="64" Height="64"
                                                                    Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                                    Margin="0,0,0,16" />
                                                                <TextBlock Text="请先选择主表工作表"
                                                                           Style="{StaticResource MD3BodyLarge}"
                                                                           Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                                           HorizontalAlignment="Center" />
                                                                <TextBlock Text="选择工作表后将显示数据预览"
                                                                           Style="{StaticResource MD3BodyMedium}"
                                                                           Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                                           HorizontalAlignment="Center"
                                                                           Margin="0,8,0,0" />
                                                            </StackPanel>

                                                            <!-- Data Display -->
                                                            <ScrollViewer
                                                                Visibility="{Binding HasPrimaryPreviewData, 
                                  Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                MaxHeight="500"
                                                                Style="{StaticResource MD3ScrollViewer}">
                                                                <StackPanel>
                                                                    <!-- Single Worksheet Data -->
                                                                    <DataGrid
                                                                        ItemsSource="{Binding PrimaryPreviewData}"
                                                                        Style="{StaticResource MD3DataGrid}"
                                                                        AutoGenerateColumns="True"
                                                                        IsReadOnly="True"
                                                                        MaxHeight="400" />
                                                                </StackPanel>
                                                            </ScrollViewer>
                                                        </Grid>
                                                    </TabItem>

                                                    <!-- Secondary Data Tab -->
                                                    <TabItem Style="{StaticResource MD3TabItem}">
                                                        <TabItem.Header>
                                                            <StackPanel Orientation="Horizontal">
                                                                <materialDesign:PackIcon Kind="Table"
                                                                    Width="20" Height="20"
                                                                    Margin="0,0,8,0" />
                                                                <TextBlock Text="辅助表数据" />
                                                                <materialDesign:Chip
                                                                    Content="{Binding SelectedSecondaryWorksheets.Count, StringFormat='{}{0}个工作表'}"
                                                                    Margin="8,0,0,0"
                                                                    Style="{StaticResource MaterialDesignOutlineChip}"
                                                                    FontSize="10"
                                                                    Visibility="{Binding SelectedSecondaryWorksheets.Count, 
                                           Converter={StaticResource CountToVisibilityConverter}}" />
                                                            </StackPanel>
                                                        </TabItem.Header>
                                                        <Grid Margin="0,16,0,0">
                                                            <!-- Empty State -->
                                                            <StackPanel VerticalAlignment="Center"
                                                                        HorizontalAlignment="Center"
                                                                        Visibility="{Binding HasSecondaryPreviewData, 
                              Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                                                <materialDesign:PackIcon Kind="TableOff"
                                                                    Width="64" Height="64"
                                                                    Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                                    Margin="0,0,0,16" />
                                                                <TextBlock Text="请先选择辅助表工作表"
                                                                           Style="{StaticResource MD3BodyLarge}"
                                                                           Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                                           HorizontalAlignment="Center" />
                                                                <TextBlock Text="选择工作表后将显示数据预览"
                                                                           Style="{StaticResource MD3BodyMedium}"
                                                                           Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                                           HorizontalAlignment="Center"
                                                                           Margin="0,8,0,0" />
                                                            </StackPanel>

                                                            <!-- Data Display -->
                                                            <ScrollViewer
                                                                Visibility="{Binding HasSecondaryPreviewData, 
                                  Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                MaxHeight="500"
                                                                Style="{StaticResource MD3ScrollViewer}">
                                                                <StackPanel>
                                                                    <!-- Single Worksheet Data -->
                                                                    <DataGrid
                                                                        ItemsSource="{Binding SecondaryPreviewData}"
                                                                        Style="{StaticResource MD3DataGrid}"
                                                                        AutoGenerateColumns="True"
                                                                        IsReadOnly="True"
                                                                        MaxHeight="400" />
                                                                </StackPanel>
                                                            </ScrollViewer>
                                                        </Grid>
                                                    </TabItem>
                                                </TabControl>
                                            </ScrollViewer>
                                        </Grid>

                                        
                                    </StackPanel>
                                </materialDesign:Card>

                            </StackPanel>
                        </ScrollViewer>

                        <!-- Bottom Action Bar -->
                        <materialDesign:ColorZone Grid.Row="2"
                                                  Mode="Custom"
                                                  Background="{StaticResource MD3SurfaceVariantBrush}"
                                                  Foreground="{StaticResource MD3OnSurfaceVariantBrush}"
                                                  CornerRadius="0,0,16,16"
                                                  Padding="24,16">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!-- Status Information -->
                                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                    <StackPanel Orientation="Horizontal">
                                        <materialDesign:PackIcon Kind="Information"
                                                                 Width="16" Height="16"
                                                                 VerticalAlignment="Center"
                                                                 Margin="0,0,8,0" />
                                        <TextBlock Text="{Binding StatusMessage}"
                                                   Style="{StaticResource MD3BodyMedium}" />
                                    </StackPanel>

                                    <!-- Progress Bar -->
                                    <ProgressBar Value="{Binding ProgressValue}"
                                                 Maximum="{Binding ProgressMaximum}"
                                                 Height="4"
                                                 Margin="0,8,0,0"
                                                 Width="400"
                                                 HorizontalAlignment="Left"
                                                 Style="{StaticResource MaterialDesignLinearProgressBar}"
                                                 Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" />

                                    <!-- Statistics -->
                                    <StackPanel Orientation="Horizontal"
                                                Margin="0,8,0,0"
                                                Visibility="{Binding IsBusy, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                        <materialDesign:Chip
                                            Content="{Binding PrimaryFile.RowCount, StringFormat='主表: {0}行'}"
                                            Style="{StaticResource MaterialDesignOutlineChip}"
                                            FontSize="11"
                                            Margin="0,0,8,0"
                                            Visibility="{Binding PrimaryFile.IsLoaded, 
                                                                   Converter={StaticResource BooleanToVisibilityConverter}}" />

                                        <materialDesign:Chip
                                            Content="{Binding SecondaryFile.RowCount, StringFormat='辅助表: {0}行'}"
                                            Style="{StaticResource MaterialDesignOutlineChip}"
                                            FontSize="11"
                                            Margin="0,0,8,0"
                                            Visibility="{Binding SecondaryFile.IsLoaded, 
                                                                   Converter={StaticResource BooleanToVisibilityConverter}}" />

                                        <materialDesign:Chip
                                            Content="{Binding FieldMappings.Count, StringFormat='{}{0}个映射'}"
                                            Style="{StaticResource MaterialDesignOutlineChip}"
                                            FontSize="11"
                                            Visibility="{Binding FieldMappings.Count, 
                                                                   Converter={StaticResource CountToVisibilityConverter}}" />

                                        <!-- 预览状态提示 -->
                                        <materialDesign:Chip Content="性能优化模式 - 预览已关闭"
                                                             Style="{StaticResource MaterialDesignOutlineChip}"
                                                             FontSize="11"
                                                             Margin="8,0,0,0"
                                                             Background="{StaticResource MD3TertiaryContainerBrush}"
                                                             Foreground="{StaticResource MD3OnTertiaryContainerBrush}"
                                                             Visibility="{Binding IsPreviewEnabled, 
                                     Converter={StaticResource InverseBooleanToVisibilityConverter}}" />

                                        <materialDesign:Chip Content="预览模式 - 可查看数据内容"
                                                             Style="{StaticResource MaterialDesignOutlineChip}"
                                                             FontSize="11"
                                                             Margin="8,0,0,0"
                                                             Background="{StaticResource MD3PrimaryContainerBrush}"
                                                             Foreground="{StaticResource MD3OnPrimaryContainerBrush}"
                                                             Visibility="{Binding IsPreviewEnabled, 
                                     Converter={StaticResource BooleanToVisibilityConverter}}" />
                                    </StackPanel>
                                </StackPanel>

                                <!-- Action Buttons -->
                                <StackPanel Grid.Column="1"
                                            Orientation="Horizontal"
                                            VerticalAlignment="Center">

                                    <!-- Diagnose Button -->
                                    <Button Command="{Binding DiagnoseMatchingCommand}"
                                            Style="{StaticResource MD3TextButton}"
                                            ToolTip="诊断匹配问题"
                                            Margin="0,0,8,0">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="Microscope"
                                                                     Width="18" Height="18"
                                                                     Margin="0,0,8,0" />
                                            <TextBlock Text="诊断" />
                                        </StackPanel>
                                    </Button>

                                    <!-- Save Configuration Button -->
                                    <Button Command="{Binding SaveConfigurationCommand}"
                                            Style="{StaticResource MD3OutlinedButton}"
                                            Margin="0,0,8,0">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="ContentSave"
                                                                     Width="18" Height="18"
                                                                     Margin="0,0,8,0" />
                                            <TextBlock Text="保存配置" />
                                        </StackPanel>
                                    </Button>

                                    <!-- Load Configuration Button -->
                                    <Button Command="{Binding LoadConfigurationCommand}"
                                            Style="{StaticResource MD3OutlinedButton}"
                                            Margin="0,0,8,0">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="FolderOpen"
                                                                     Width="18" Height="18"
                                                                     Margin="0,0,8,0" />
                                            <TextBlock Text="加载配置" />
                                        </StackPanel>
                                    </Button>

                                    <!-- Reset Button -->
                                    <Button Command="{Binding ResetConfigurationCommand}"
                                            Style="{StaticResource MD3OutlinedButton}"
                                            Margin="0,0,16,0">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="Refresh"
                                                                     Width="18" Height="18"
                                                                     Margin="0,0,8,0" />
                                            <TextBlock Text="重置" />
                                        </StackPanel>
                                    </Button>

                                    <!-- Start Merge Button -->
                                    <Button Command="{Binding StartMergeCommand}"
                                            Style="{StaticResource MD3FilledButton}"
                                            Padding="32,12"
                                            FontSize="16"
                                            IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBooleanConverter}}">
                                        <StackPanel Orientation="Horizontal">
                                            <materialDesign:PackIcon Kind="PlayArrow"
                                                                     Width="20" Height="20"
                                                                     Margin="0,0,8,0" />
                                            <TextBlock Text="开始合并" FontWeight="Medium" />
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </materialDesign:ColorZone>
                    </Grid>
                </Border>

                <!-- Loading Overlay -->
                <Grid Background="#E0000000"
                      Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">

                    <!-- Loading Card -->
                    <materialDesign:Card HorizontalAlignment="Center"
                                         VerticalAlignment="Center"
                                         Style="{StaticResource MD3ElevatedCard}"
                                         Padding="48"
                                         MinWidth="400"
                                         MaxWidth="600">
                        <StackPanel>
                            <!-- Loading Animation -->
                            <Grid HorizontalAlignment="Center" Margin="0,0,0,32">
                                <!-- Outer Ring -->
                                <Ellipse Width="80" Height="80"
                                         Stroke="{StaticResource MD3PrimaryBrush}"
                                         StrokeThickness="2"
                                         Opacity="0.2" />

                                <!-- Inner Animated Ring -->
                                <Ellipse Width="80" Height="80"
                                         Stroke="{StaticResource MD3PrimaryBrush}"
                                         StrokeThickness="4"
                                         StrokeDashArray="20,60"
                                         RenderTransformOrigin="0.5,0.5">
                                    <Ellipse.RenderTransform>
                                        <RotateTransform x:Name="LoadingRotateTransform" />
                                    </Ellipse.RenderTransform>
                                    <Ellipse.Triggers>
                                        <EventTrigger RoutedEvent="Loaded">
                                            <BeginStoryboard>
                                                <Storyboard>
                                                    <DoubleAnimation Storyboard.TargetName="LoadingRotateTransform"
                                                                     Storyboard.TargetProperty="Angle"
                                                                     From="0" To="360"
                                                                     Duration="0:0:2"
                                                                     RepeatBehavior="Forever">
                                                        <DoubleAnimation.EasingFunction>
                                                            <CubicEase EasingMode="EaseInOut" />
                                                        </DoubleAnimation.EasingFunction>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                    </Ellipse.Triggers>
                                </Ellipse>

                                <!-- Center Icon -->
                                <materialDesign:PackIcon Kind="TableMergeCells"
                                                         Width="32" Height="32"
                                                         Foreground="{StaticResource MD3PrimaryBrush}"
                                                         HorizontalAlignment="Center"
                                                         VerticalAlignment="Center" />
                            </Grid>

                            <!-- Status Text -->
                            <TextBlock Text="{Binding StatusMessage}"
                                       Style="{StaticResource MD3TitleMedium}"
                                       HorizontalAlignment="Center"
                                       TextWrapping="Wrap"
                                       Margin="0,0,0,24" />

                            <!-- Progress Bar -->
                            <ProgressBar Value="{Binding ProgressValue}"
                                         Maximum="{Binding ProgressMaximum}"
                                         Height="8"
                                         Style="{StaticResource MaterialDesignLinearProgressBar}"
                                         materialDesign:TransitionAssist.DisableTransitions="False" />

                            <!-- Progress Text -->
                            <StackPanel Orientation="Horizontal"
                                        HorizontalAlignment="Center"
                                        Margin="0,16,0,0">
                                <TextBlock Style="{StaticResource MD3BodyMedium}">
                                    <Run Text="进度: " />
                                    <Run Text="{Binding ProgressValue, Mode=OneWay}" FontWeight="Medium" />
                                    <Run Text=" / " />
                                    <Run Text="{Binding ProgressMaximum, Mode=OneWay}" FontWeight="Medium" />
                                </TextBlock>

                                <TextBlock
                                    Text="{Binding ProgressValue, Mode=OneWay, 
                                             Converter={StaticResource ProgressToPercentageConverter}}"
                                    Style="{StaticResource MD3BodyMedium}"
                                    FontWeight="Medium"
                                    Margin="16,0,0,0" />
                            </StackPanel>

                            <!-- Additional Info -->
                            <materialDesign:Card Style="{StaticResource MD3OutlinedCard}"
                                                 Background="{StaticResource MD3TertiaryContainerBrush}"
                                                 Margin="0,24,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <materialDesign:PackIcon Kind="InformationOutline"
                                                             Width="16" Height="16"
                                                             Foreground="{StaticResource MD3OnTertiaryContainerBrush}"
                                                             Margin="0,0,8,0" />
                                    <TextBlock Text="请耐心等待，处理大量数据可能需要一些时间..."
                                               Style="{StaticResource MD3BodySmall}"
                                               Foreground="{StaticResource MD3OnTertiaryContainerBrush}" />
                                </StackPanel>
                            </materialDesign:Card>
                        </StackPanel>
                    </materialDesign:Card>
                </Grid>

                <!-- Snackbar Host -->
                <materialDesign:Snackbar x:Name="MainSnackbar"
                                         MessageQueue="{materialDesign:MessageQueue}"
                                         VerticalAlignment="Bottom"
                                         HorizontalAlignment="Center"
                                         Margin="0,0,0,100" />

            </Grid>
        </materialDesign:DialogHost>
    </materialDesign:DialogHost>
</Window>